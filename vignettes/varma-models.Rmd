---
title: "Bayesian VARMA BEKK models"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{varma-models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Varstan package (*var models in stan*) provides an interface to fit Bayesian generalized varma bekk models using [Stan](http://mc-stan.org/), which is a C++ package for performing full Bayesian inference. As a simple example we provide the simulate sample Astrovan, its a n = 200  simulated time series of dimension 2 that follows a varbekk model

$$Atrovan  \sim VAR(p=1)BEKK(s=1,k=1,h=1)$$

Its important to say that bayesian varma models are still under study there is no specified priors for the matrices parameters. In the current literature the fitted varma models use normal priors. We encourage you stay with the current one dimensional implemented models and keep updating varstan package for furthers adaptions and improvements of varma models.


```{r, message=FALSE}
library(varstan)
library(ggplot2)
library(bayesplot)
library(gridExtra)
```


Lets have a stochastic multivariate time process $Y = \{Y_i\}_{i=0}^{n}$ of dimension d ($Y_{i}\in \mathbb{R}^d$). It follows a varma bekk model if

$$Y_{i} = \mu_0 +\sum_{j=1}^p\Phi_jY_{i-j}-\sum_{j=1}^q\Theta_{j}\epsilon_{i-j}+\sum_{j=1}^hvech(\Sigma_{i-j})H_i $$

$$\Sigma_i = \Sigma_0^t\Sigma_0 +\sum_{j=1}^s\alpha_j^t\epsilon_{i-j}\epsilon_{i-j}^t\alpha_j +\sum_{j=1}^k\beta_j^t\Sigma_{i-j}\beta_j$$
$$\epsilon_i \sim N_d(\mathbb{0},\Sigma_i) $$
Where $$Y_i,\epsilon_i,\mu_0, \mathbb{0} \in \mathbb{R}^d$$
$$\Sigma_i,\Phi_i,\Theta_i,\alpha_i, \beta_i \in  \mathbb{R}^{dxd}$$ and $$H_i \in \mathbb{R}^{mx d}, \text{ } m = d(d+1)/2$$

Fitting a varmabekk model with varstan is simply call the varma function as follows:
```{r}
md1 = varma(Astrovan,p = 2,q = 0,sd = mbekk(s=1,k=1,h=0))
report(md1)
```

Just like the arima object model, you can change and personalize your own priors, but we recomend to stick to the normal distribution, priors for matrix is still in study and there are now full results for varma priors with different distributions.

Changing prior parameters with the varma objects:
```{r}
md1 = set_prior(md1,type = "ar",lag = 1,par1 = 0.05,par2 = 0.5,dist = "normal")
get_prior(md1,type = "ar")
```

The normal prior means that every matrix coefficient has a normal distribution with the specified parameters.

### Specifying a Prior to the covariance matrix


As an stan consideration the prior for the covariance matrix $\Sigma_0$ is an LKJ(k) prior distribution with parameter $k > 0$ proposed by Lewandoswki, Kurowicka, and Joe (2009). So our covariance matrix is factorized as follows:

$$\Sigma_0 = D(\sigma_0)\Omega D(\sigma_0)$$
Where $\Omega$ is the Correlation matrix, and $D(\sigma_0)$ is a diagonal matrix with the standard deviaton as diagonal elements. The expected value of the LKJ-prior is the identity matrix (implying correlations of zero) for any positive value of $k$, which can be interpreted like the shape parameter of a symmetric beta distribution [Stan](Stan Development Team 2017b). If $k = 1$ (the default in brms) the density is uniform over correlation matrices of the respective dimension. If $k > 1$, the identity matrix is the mode of the prior, with a sharper peak in the density for larger values of $k$. If $0 < k < 1$ the prior is U-shaped having a trough at the identity matrix, which leads to higher probabilities for non-zero correlations. For every element of $\sigma_0$, any prior can be applied that is defined on
the non-negative reals only. (see [brms article](https://www.jstatsoft.org/article/view/v080i01) for more details). As default we use a half t-student with 7 degree fredoms it can be changed using the **set_prior** function, specifying *type="sigma0*.

```{r}
get_prior(md1,type = "sigma0")
```

It has been shown that this  prior selection has better results than a selection a of Wishart distribution which it has no geometric interpretation.

### Generalized t-student distribution

For estimating Generalized t-Student VARMA Bekk model proposed by [Cruz (2015)](http://www.pg.im.ufrj.br/teses/Estatistica/Doutorado/029.pdf) is  as follows:

$$Y_i \sim VARMA(p,q)Bekk(s,k)$$
$$\epsilon_i \sim N(0,\Lambda_t^{1/2}\Sigma_t\Lambda_t^{1/2}), \text{ }\Lambda_t = Diag(\lambda_{1t}^{-1},\ldots,\lambda_{dt}^{-1})$$
Where $$\lambda_{it}/v_j \sim Gama(v_j/2,v_j/2)$$

Making a Generalized t-student varma model with varma is simply updating the **genT** value
```{r}
md1 = varma(Astrovan,p = 2,q = 0,sd = mbekk(s=1,k=1,h=0),genT = TRUE)
report(md1)
```

#### Specifying the degree freedom parameter $v_j$

If a Generalized t-student model is specified, varstan by defaults use a gamma prior ($v_j \sim Gamma(2,0.1)$), this following the  recomendations proposed by [Juarez and Steel](https://amstat.tandfonline.com/doi/abs/10.1198/jbes.2009.07145#.Xc8081dKhPY). They concluded that the gamma prior gets better results than a Jeffreys or exponential priors. In varstan the next distributions can be used

 + half normal
 + Jeffreys
 + Gamma
 + exponential (Gamma with par1 = 1)

For Changing the deffault priors just call the set_prior function

```{r}
md1 = set_prior(md1,type = "dfv",dist = "Jeffrey")
get_prior(md1,"dfv")
```

or 

```{r}
md1 = set_prior(md1,type = "dfv",par1 = 2,par2 = 0.1,dist = "gamma")
get_prior(md1,"dfv")
```


### Estimating a Varbekk model for astrovan

The varstan function calls the stan sampler, make the stablished simulation and returns a varstan object with the current results.
On the next chunk the stan sampler is called simulating 1 chain, with 2000 iterations and 1000 warm up

```{r}
md1 = varma(Astrovan,p = 1,q = 0,sd = mbekk(s=1,k = 1),genT = TRUE)
sft1 = varstan(md1,chains = 1,iter = 2000)
```


A summary of the results can be obtained using the summary_varstan function
```{r}
summary(sft1,robust = TRUE)
```

The point estimate values can be obtained by
```{r}
pe = posterior_estimate(sft1)
pe
```

The $lambda_t$ values of the diagonal matrix in the Generalized t-student model are obtained using the get_df function with robust =TRUE option ofr getting the posterior mean
```{r}
lambda1 = get_df(sft1,robust = TRUE)
head(lambda1)
```



#### Extracting simulated parameters

To get the simulated chain of an specific parameter use the **extract_stan function**, this is a replication of the extract function in rstan for varstan objects, an it gets the simulated chains of specified parameters.

```{r}
post = extract_stan(sft1,pars = "alpha",permuted = TRUE,inc_warmup = FALSE,include = TRUE)
post = as.data.frame(post)
head(post)
```

A simple diagnostic plot for the arch[1,1] $\alpha(1,1)$  parameter is possible, using the bayesplot package that visualize posterior distributions and other diagnosis.


```{r fig.width=7.3}
 color_scheme_set("viridis")

  p1 = mcmc_trace(post,  pars = "alpha.1.1.1",
        facet_args = list(nrow = 2, labeller = label_parsed)) + 
        facet_text(size = 15)
  p2 = mcmc_hist(post, pars = "alpha.1.1.1",facet_args = list(nrow = 2))+
    facet_text(size = 15)
  p3 = mcmc_acf(post, pars = "alpha.1.1.1", lags = 10,)
  grid.arrange(p1,p2,p3,nrow = 2,layout_matrix = matrix(c(1,3,2,3),ncol=2,byrow=TRUE))
```

For further plot diagnostic you can extract the stanfit object from varstan as follows
```{r}
stanfit = get_rstan(sft1)
class(stanfit)
```




```{r}
yh = posterior_predict(obj = sft1,h = 5)
head(yh)
```

